name: Force Cleanup Deployments
on: workflow_dispatch

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: Delete All Deployments and Environments
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # 1. Dobijamo listu svih environment-a
          environments=$(gh api repos/${{ github.repository }}/environments --jq '.environments[].name')

          for env in $environments; do
            echo "Čistim environment: $env"
            
            # 2. Dobijamo sve deployment ID-eve za taj env
            deployments=$(gh api repos/${{ github.repository }}/deployments?environment=$(echo $env | jq -sRr @uri) --jq '.[].id')
            
            for id in $deployments; do
              # 3. Moramo prvo postaviti status na 'inactive' da bi brisanje radilo
              gh api -X POST repos/${{ github.repository }}/deployments/$id/statuses -f state='inactive'
              
              # 4. Brišemo deployment
              gh api -X DELETE repos/${{ github.repository }}/deployments/$id
              echo "Obrisan deployment $id"
            done
            
            # 5. Na kraju brišemo sam environment rekord
            gh api -X DELETE repos/${{ github.repository }}/environments/$(echo $env | jq -sRr @uri)
            echo "Obrisan environment: $env"
          done